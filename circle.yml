machine:
  python:
    version: 2.7.10
  environment:
    PATH: "${HOME}/bin:${PATH}"
    PACKER_URL: "https://dl.bintray.com/mitchellh/packer/packer_0.8.6_linux_amd64.zip"
    PACKER_SHA256SUM: "2f1ca794e51de831ace30792ab0886aca516bf6b407f6027e816ba7ca79703b5"

dependencies:
  cache_directories:
    - ~/bin
  pre:
    - |
      if [ ! -e "${HOME}/bin/packer" ]; then
        curl -Lo packer.zip "${PACKER_URL}"
        unzip -d ~/bin packer.zip
      fi
    - packer version
    - pip install ansible
    - ansible-galaxy install -p roles uchida.poudriere,0.2.2

test:
  override:
    - sh -n http/installerconfig
    - find scripts -name '*.sh' -print0 | xargs -0 sh -n
    - packer validate template.json
    - ansible-playbook -i localhost, --syntax-check provision.yml

deployment:
  release:
    tag: /[0-9]+\.[0-9]+\.[0-9]+/
    commands:
      - sed -i "s/0.0.0/$(git describe --abbrev=0 --tags)/" template.json
      - packer push template.json
